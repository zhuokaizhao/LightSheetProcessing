# LightSheetProcessing
LightSheetProcessing (LSP) is a software that processes image data captured by a light sheet fluorescence microscopy. LSP reads a number of or one specific microscopy image data file created in the Carl Zeiss CZI format, which saves image stacks, time lapse series and tile images captured from a Carl Zeiss microscope. LSP first organized them into [detached-header NRRD File format](http://teem.sourceforge.net/nrrd/format.html#general.2) and later generates PNG images as well as corresponding AVI videos based on the Maximum Intensity Projection (MIP) and Average Intensity Projection (AIP) of the input data.

## Dependencies
1. **Language**:
- C++ 11
2. **Standard libraries** (Specifically required libraries showed in parentheses):
- [Libxml2](http://xmlsoft.org/)
- [Boost](https://www.boost.org/) (boost_system, boost_filesystem)
- [OpenCV3](https://opencv.org/opencv-3-4-1.html) (opencv_core, opencv_videoio, opencv_imgcodecs, opencv_imgproc)
- [FFTW3](http://www.fftw.org/) 
- [libpng](http://www.libpng.org/pub/png/libpng.html) 
- [zlib](https://zlib.net/)
3. **Customized libraries**:
- [Teem](http://teem.sourceforge.net/)
    
## Compilation
After getting all the dependencies ready, under the main directory `LightSheetProcessing/`, run
```
sh scripts/compile.sh
```		

Note: The script is written to be run on Linux system, modifications are required if running on other platforms. By default it will add the install path `/LightSheetProcessing/LSP-INSTALL/` to your `~/.bash_profile` and `~/.profile`.

## Standard input data format
1. All files should be in the Carl Zeiss CZI format (.czi files).
2. If you want LSP to process a number of consecutive files, please put all of them under one path (for example, `~/czi/*.czi`). And name them to have the following format, note that the first (0 timestamp) should have no parentheses.
```
data_name.czi (0 timestamp data)
data_name(1).czi
data_name(2).czi
...
```

## Running
1. Run `lsp -h` to show the most general information about the program.
2. LSP includes two general processing pipelines - `lsp start` and `lsp start_with_corr`
- `lsp start` 
<br /> `lsp start` is the processing pipeline that should be used when there is no obvious specimen drift when gathering the microscope data. It does not include any drift correction algorithm. More specifically, it combines `lsp skim`, `lsp proj` and `lsp anim`, which are responsible for reading raw CZI data, generating MIP and MIA projection files, and producing final image sequences respectively. Details will be showed in more detail in the next bullet point.
  - Required arguments:
    - `-c, czi_path`, path which contains all the input files
    - `-n, nhdr_path`, path which will contain all the NHDR headers and XML data files generated by `lsp skim`
    - `-p, proj_path`, path which will contain all the NRRD projection files generated by `lsp proj`
    - `-a, anim_path`, path which will contain all the PNG images and AVI videos generated by `lsp anim`
  - Optional arguments:
    - `-f, fps`, frame per second (fps) of the generated AVI video, default is 10
    - `-v, verbose`, 0 for essential progress outputs only, 1 for all the printouts
  - Output formats:
    - Same as those described in separate programs

- `lsp start_with_corr`


3. LSP currently includes four subcommands: `lsp skim`, `lsp proj`, `lsp anim` and `lsp start`. Same to the general command `lsp`, each subcommand could be run to show help instructions when added `-h` flag as well.     
- `lsp skim`
<br /> `lsp skim` provides utilities for getting information out of CZI files and organizes them into detached-header NRRD file format. More specifically, it generates .nhdr NRRD header files to permit extracting the image and essential meta data from CZI files.
  - Required arguments:
    - `-i, czi_path`, input path which contains all the input files
    - `-o, nhdr_path`, output path for the generated NHDR headers and .xml data files
    - `-v, verbose`, 0 for essential progress outputs only, 1 for all the printouts
  - Output formats:
    - All NHDR headers and XML data files will have three-digit names saved into `nhdr_path`, which correspond to their time stamps
    ```
    000.nhdr, 000.xml;
    001.nhdr, 001.xml;
    002.nhdr, 002.xml;
    ...
    ```

- `lsp proj`
<br /> `lsp proj` creates NRRD projection files in X-Y, X-Z and Y-Z planes based on NHDR headers and XML data files that were generated by `lsp skim`. 
  - Required arguments:
    - `-i, nhdr_path`, input path which contains all the NHDR headers and XML data files generated by `lsp skim`
    - `-o, proj_path`, output path for the generated NRRD projection files
  - Optional arguments:
    - `-v, verbose`, 0 for essential progress outputs only, 1 for all the printouts
  - Output formats:
    - NRRD projection files in all three planes will have the following format:
    ```
    000-projXY.nrrd, 000-projXZ.nrrd, 000-projYZ.nrrd;
    001-projXY.nrrd, 001-projXZ.nrrd, 001-projYZ.nrrd;
    002-projXY.nrrd, 002-projXZ.nrrd, 002-projYZ.nrrd;
    ...
    ```
- `lsp anim`
<br /> `lsp anim` creates PNG images as well as corresponding AVI videos from NRRD projection files generated by `skim proj`
  - Required arguments:
    - `-i, nhdr_path`, input path which contains all the NHDR headers and XML data files generated by `lsp skim`
    - `-p, proj_path`, input path which contains all the NRRD projection files generated by `lsp proj`
    - `-o, anim_path`, output path for the generated PNG images and AVI videos
  - Optional arguments:
    - `-n, max_file_number`, max number of files that we want to process
    - `-f, fps`, frame per second (fps) of the generated AVI video, default is 10
    - `-d, dsample`, amount by which to down-sample the input data, default is 1.0
    - `-x, scalex`, scaling on the x axis, default: 1.0
    - `-z, scalez`, scaling on the z axis, default: 1.0
    - `-v, verbose`, 0 for essential progress outputs only, 1 for all the printouts
  - Output formats:
    - NRRD projection files in all three planes will have the following format:
    ```
    000-projXY.nrrd, 000-projXZ.nrrd, 000-projYZ.nrrd;
    001-projXY.nrrd, 001-projXZ.nrrd, 001-projYZ.nrrd;
    002-projXY.nrrd, 002-projXZ.nrrd, 002-projYZ.nrrd;
    ...
    ```



 